<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Account System</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: #fff; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h1, h2 { text-align: center; color: #1c1e21; }
        .input-group, .radio-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; color: #606770; }
        input[type="radio"] { margin-right: 0.5rem; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="password"] { width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 0.75rem; border: none; border-radius: 6px; background-color: #1877f2; color: #fff; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #166fe5; }
        button.secondary { background-color: #e4e6eb; color: #1c1e21; margin-top: 0.5rem; }
        button.secondary:hover { background-color: #d8dbdf; }
        #status { text-align: center; margin-top: 1rem; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login View -->
        <div id="login-section">
            <h1>Login</h1>
            <div class="input-group">
                <label for="login-contact">Email or Phone</label>
                <input type="text" id="login-contact" placeholder="Enter your email or phone">
            </div>
            <div class="input-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password">
            </div>
            <button onclick="loginUser()">Login</button>
            <button class="secondary" onclick="showView('otp-section')">Create a New Account</button>
        </div>

        <!-- OTP Verification View -->
        <div id="otp-section" class="hidden">
            <h1>Create Account</h1>
            <p style="text-align:center; color: #606770;">First, let's verify your contact info.</p>
            <div class="radio-group">
                <label>Verification Method:</label>
                <input type="radio" id="method-email" name="method" value="email" checked onchange="toggleInput()"> <label for="method-email">Email</label>
                <input type="radio" id="method-phone" name="method" value="phone" onchange="toggleInput()"> <label for="method-phone">Phone</label>
            </div>
            <div class="input-group" id="email-group">
                <label for="email-input">Email Address</label>
                <input type="email" id="email-input" placeholder="you@example.com">
            </div>
            <div class="input-group hidden" id="phone-group">
                <label for="phone-input">10-digit phone number</label>
                <input type="tel" id="phone-input" placeholder="9876543210" maxlength="10">
            </div>
            <button onclick="sendOTP()">Send OTP</button>
            <button class="secondary" onclick="showView('login-section')">Already have an account?</button>
        </div>

        <!-- OTP Entry View -->
        <div id="otp-verify-section" class="hidden">
            <h2>Verify Code</h2>
            <div class="input-group">
                <label for="otp-input">Enter 6-Digit OTP</label>
                <input type="text" id="otp-input" maxlength="6">
            </div>
            <button onclick="verifyOTP()">Verify Code</button>
        </div>
        
        <!-- Registration (Set Password) View -->
        <div id="register-section" class="hidden">
             <h2>Set Your Password</h2>
             <div class="input-group">
                <label for="register-password">Create a Password</label>
                <input type="password" id="register-password">
             </div>
             <button onclick="registerUser()">Create Account</button>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-section" class="hidden">
            <h2>My Account</h2>
            <p>Welcome, <strong id="user-welcome-id"></strong>!</p>
            <div id="orders-list">
                <h3>Your Orders</h3>
                <p>You have no orders yet.</p>
            </div>
            <button class="secondary" onclick="logout()">Logout</button>
        </div>

        <p id="status"></p>
    </div>

    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // =================================================================================
        // === CONFIGURATION - PASTE YOUR KEYS AND URLS HERE ===============================
        // =================================================================================

        const firebaseConfig = {
  apiKey: "AIzaSyC4Bzd1dEV7RY7VsXF5UqxaC0FUoohXDp8",
  authDomain: "data-managment-tcc.firebaseapp.com",
  projectId: "data-managment-tcc",
  storageBucket: "data-managment-tcc.firebasestorage.app",
  messagingSenderId: "1077661494535",
  appId: "1:1077661494535:web:ceceda8a3d2029e2cd69a2",
  measurementId: "G-22M7JDJZHM"
};
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKoLkf45GTNoiv4QHKCXkQFmBfgVaj2EujOFpPhNDe4jdEJvS91E0bfApWKqGfw_ly2A/exec';

        // =================================================================================
        // === APPLICATION LOGIC - DO NOT EDIT BELOW THIS LINE =============================
        // =================================================================================
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let generatedOTP = '';
        let selectedMethod = 'email';
        let verifiedContact = ''; // Store the verified email/phone

        // --- UI Control ---
        const views = ['login-section', 'otp-section', 'otp-verify-section', 'register-section', 'dashboard-section'];
        function showView(viewId) {
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById('status').textContent = '';
        }
        
        function toggleInput() {
            selectedMethod = document.getElementById('method-email').checked ? 'email' : 'phone';
            document.getElementById('email-group').classList.toggle('hidden', selectedMethod !== 'email');
            document.getElementById('phone-group').classList.toggle('hidden', selectedMethod !== 'phone');
        }

        // --- OTP LOGIC (Same as before, but with UI changes) ---
        function sendOTP() {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'Sending...';
            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
            console.log(`Generated OTP: ${generatedOTP}`);

            let payload = { otp: generatedOTP };
            if (selectedMethod === 'email') {
                verifiedContact = document.getElementById('email-input').value;
                payload.method = 'email';
                payload.email = verifiedContact;
            } else {
                let phone = document.getElementById('phone-input').value;
                verifiedContact = "+91" + phone;
                payload.method = 'phone';
                payload.phone = verifiedContact;
            }

            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
            .then(() => {
                statusEl.textContent = `OTP sent to ${verifiedContact}`;
                showView('otp-verify-section');
            }).catch(error => { statusEl.textContent = 'Error sending OTP.'; });
        }

        function verifyOTP() {
            const enteredOTP = document.getElementById('otp-input').value;
            if (enteredOTP === generatedOTP) {
                document.getElementById('status').textContent = 'Verification successful! Please set a password.';
                showView('register-section');
            } else {
                document.getElementById('status').textContent = 'Invalid OTP. Please try again.';
            }
        }

        // --- PASSWORD HASHING ---
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // --- USER ACCOUNT LOGIC ---
        async function registerUser() {
            const statusEl = document.getElementById('status');
            const password = document.getElementById('register-password').value;
            if (password.length < 6) {
                statusEl.textContent = 'Password must be at least 6 characters long.';
                return;
            }
            statusEl.textContent = 'Creating account...';

            const userRef = db.collection('users').doc(verifiedContact);
            const doc = await userRef.get();

            if (doc.exists) {
                statusEl.textContent = 'An account with this contact info already exists.';
                showView('login-section');
                return;
            }

            const passwordHash = await hashPassword(password);
            await userRef.set({
                contact: verifiedContact,
                passwordHash: passwordHash,
                createdAt: new Date(),
                orders: [] // Start with an empty list of orders
            });
            
            statusEl.textContent = 'Account created successfully! Please log in.';
            showView('login-section');
        }

        async function loginUser() {
            const statusEl = document.getElementById('status');
            const contact = document.getElementById('login-contact').value;
            const password = document.getElementById('login-password').value;
            statusEl.textContent = 'Logging in...';

            const userRef = db.collection('users').doc(contact);
            const doc = await userRef.get();

            if (!doc.exists) {
                statusEl.textContent = 'No account found with this contact info.';
                return;
            }

            const userData = doc.data();
            const passwordHash = await hashPassword(password);

            if (passwordHash === userData.passwordHash) {
                statusEl.textContent = 'Login successful!';
                loadDashboard(userData);
            } else {
                statusEl.textContent = 'Incorrect password.';
            }
        }

        function loadDashboard(userData) {
            document.getElementById('user-welcome-id').textContent = userData.contact;
            const ordersList = document.getElementById('orders-list');
            // Here you would render the user's orders from userData.orders
            // For now, we'll keep the default "no orders yet" message.
            showView('dashboard-section');
        }

        function logout() {
            // Simply show the login screen again
            verifiedContact = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-contact').value = '';
            showView('login-section');
        }

        // Set initial view
        window.onload = () => showView('login-section');

    </script>
</body>
</html>
